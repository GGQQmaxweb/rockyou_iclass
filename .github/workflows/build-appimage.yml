name: Build & Publish AppImage

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      REPO_NAME: ${{ github.event.repository.name }}
      VERSION: ${{ github.event.release.tag_name || 'dev' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install required system packages
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-setuptools \
          patchelf \
          desktop-file-utils \
          libgdk-pixbuf2.0-dev \
          fakeroot \
          strace \
          fuse \
          libfuse2 \

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install appimage-builder
      run: |
        pip install --upgrade pip
        pip install appimage-builder


    # --------------------------------------------
    # Write AppImageBuilder.yml dynamically
    # --------------------------------------------
    - name: Generate AppImageBuilder.yml
      run: |
        mkdir -p appimage/AppDir
        cat > AppImageBuilder.yml << 'EOF'
        version: 1
        AppDir:
          path: appimage/AppDir

          app_info:
            id: ${REPO_NAME}
            name: ${REPO_NAME}
            icon: ${REPO_NAME}
            version: "${VERSION}"
            exec: usr/bin/${REPO_NAME}

          runtime:
            use_system_python: true
            env:
              PYTHONHOME: "$APPDIR/usr"
              PYTHONPATH: "$APPDIR/usr/src"
              PATH: "$APPDIR/usr/bin:$PATH"

          files:
            include:
              - /usr/bin/python3
              - usr/**
            exclude:
              - "**/__pycache__"

        script: |
          python3 -m pip install --user --upgrade pip
          python3 -m pip install --user --ignore-installed -r requirements.txt

        AppImage:
          arch: x86_64
        EOF

    # --------------------------------------------
    # Copy project source (exclude appimage dir)
    # --------------------------------------------
    - name: Prepare AppDir source
      run: |
        mkdir -p appimage/AppDir/usr/src
        shopt -s extglob dotglob
        cp -r !(appimage) appimage/AppDir/usr/src/

    # --------------------------------------------
    # Create launcher: usr/bin/<repo_name>
    # --------------------------------------------
    - name: Create launcher script
      run: |
        mkdir -p appimage/AppDir/usr/bin
        cat > appimage/AppDir/usr/bin/${REPO_NAME} << EOF
        #!/bin/bash
        HERE="\$(dirname "\$(readlink -f "\$0")")"
        export PYTHONHOME="\$HERE/.."
        export PYTHONPATH="\$HERE/../src"
        exec python3 -m ${REPO_NAME} "\$@"
        EOF
        chmod +x appimage/AppDir/usr/bin/${REPO_NAME}

    # --------------------------------------------
    # Build AppImage
    # --------------------------------------------
    - name: Build AppImage
      run: |
        appimage-builder --recipe AppImageBuilder.yml --skip-tests

    # --------------------------------------------
    # Upload manually triggered build as artifact
    # --------------------------------------------
    - name: Upload AppImage Artifact (manual)
      if: ${{ github.event_name == 'workflow_dispatch' }}
      uses: actions/upload-artifact@v4
      with:
        name: "${{ env.REPO_NAME }}-appimage"
        path: "*.AppImage"

    # --------------------------------------------
    # Upload release build to GitHub Release
    # --------------------------------------------
    - name: Upload AppImage to Release
      if: ${{ github.event_name == 'release' }}
      uses: softprops/action-gh-release@v2
      with:
        files: "*.AppImage"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
